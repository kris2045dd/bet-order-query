!function(){var t=!1;$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},beforeSend:function(){t=!0},error:function(t){"419"==t.status?confirm("Session 已失效，请重新整理页面.")&&location.reload():alert("发生错误.")},complete:function(e,n){t=!1}});var e=angular.module("jsApp",["ui.bootstrap"]);function n(t,e){var n=[],r={activity1:new function(){this.isMatch=function(t,e){if("BB电子"!=t.platform)return!1;if(t.bet_amount<1)return!1;var n=e.split("|");return reg=new RegExp(n[0]+"$"),!!reg.test(t.bet_order_id)}},activity2:new function(){this.isMatch=function(t,e){if("BB电子"==t.platform)return!1;if(t.bet_amount<1)return!1;if(t.payout_amount<=0)return!1;var n=e.split("|");return t.payout_amount/t.bet_amount>n[0]}}};t.get(e+"/getActivities").then(function(t){n=t.data.data}),this.isMatch=function(t){for(var e=0,o=n.length;e<o;e++){var a=r["activity"+n[e].activity_id];if(a){var i=0;for(j_len=n[e].rules.length;i<j_len;i++)if(a.isMatch(t,n[e].rules[i]))return!0}}return!1}}e.config(["$interpolateProvider","$compileProvider",function(t,e){t.startSymbol("{*"),t.endSymbol("*}"),e.commentDirectivesEnabled(!1),e.cssClassDirectivesEnabled(!1)}]),e.filter("offset",function(){return function(t,e){return e=parseInt(e,10),t.slice(e)}}),e.filter("platform",function(){return function(t,e){if(""==e)return t;for(var n=[],r=0,o=t.length;r<o;r++){var a=t[r];a.platform==e&&n.push(a)}return n}}),e.filter("tailNo",function(){return function(t,e){if(""==e)return t;for(var n=[],r=0,o=t.length,a=new RegExp(e+"$");r<o;r++){var i=t[r];a.test(i.bet_order_id)&&n.push(i)}return n}}),e.filter("amountGreaterThan",function(){return function(t,e){if(isNaN(e)||""==e)return t;for(var n=[],r=0,o=t.length;r<o;r++){var a=t[r];a.bet_amount>=e&&n.push(a)}return n}}),e.filter("matchedOnly",function(){return function(t,e){if(!e)return t;for(var n=[],r=0,o=t.length;r<o;r++){var a=t[r];a.matched&&n.push(a)}return n}}),e.service("activityService",n),n.$inject=["$http","BASE_URI"],e.controller("BodyCtrl",["$scope","$http","platformFilter","tailNoFilter","amountGreaterThanFilter","matchedOnlyFilter","activityService","username","BASE_URI",function(e,n,r,o,a,i,u,c,s){var f=this;function l(){var t=i(f.bet_orders,f.qs.matched);t=o(t,f.qs.tail_no),t=r(t,f.qs.platform),t=a(t,f.qs.amount),f.filtered_bet_orders=t}f.username=c,f.bet_orders=[],f.filtered_bet_orders=[],f.msg=c?2:1,f.paginator={current:1,per_page:10},f.qs={platform:"",amount:"",tail_no:"",matched:!1},e.$watch(function(){return f.qs},function(t,e){l()},!0),f.loginPopup=function(){$(".login_pop").fadeIn().find("input[name='username']").focus()},f.closeLoginPopup=function(){$(".login_pop").fadeOut()},f.login=function(){if(!t){var n=login_form;if(""!=n.username.value){if(""!=n.balance.value)return isNaN(n.balance.value)?(alert("帳戶餘額格式不正確 !"),n.balance.focus(),void n.balance.select()):void $.ajax({url:s+"/login",type:"post",dataType:"json",data:$(n).serialize(),success:function(t){-1==t.error||100==t.error?(alert("登录成功."),$(".login_pop").fadeOut(),f.username=t.msg,f.msg=2,n.username.value="",n.balance.value="",e.$digest()):t.msg?alert(t.msg):alert("发生未知的错误.")}});n.balance.focus()}else n.username.focus()}},f.logout=function(){confirm("是否登出 ?")&&n.get(s+"/logout").then(function(t){f.username="",f.bet_orders=f.filtered_bet_orders=[],f.msg=1,alert("登出成功.")},function(t){alert("登出失败. ("+t.status+": "+t.statusText+")")})},f.getBetOrders=function(){t||(f.username?$.ajax({url:s+"/getBetOrders",type:"post",dataType:"json",beforeSend:function(){t=!0,$(".waiting").fadeIn()},success:function(t){-1==t.error?(f.bet_orders=t.data,f.msg=t.data.length?0:3,function(){for(var t=0,e=f.bet_orders.length;t<e;t++)f.bet_orders[t].matched=u.isMatch(f.bet_orders[t])?1:0}(),l(),e.$broadcast("afterGetData"),e.$digest()):t.msg?alert(t.msg):alert("发生未知的错误.")},complete:function(){t=!1,$(".waiting").fadeOut()}}):f.loginPopup())},f.applicable=function(t){return!!t.matched},f.activityApplying=function(e){t||$.ajax({url:s+"/activityApplying",type:"post",data:{bet_order_id:e.bet_order_id},dataType:"json",success:function(t){-1==t.error?alert("申请成功."):t.msg?alert(t.msg):alert("发生未知的错误.")}})}}]),e.controller("SearchFormCtrl",["$scope",function(t){var e,n=this;function r(r){n.countdown_sec=r||600,e=setInterval(function(){--n.countdown_sec<=0&&o(),t.$digest()},1e3)}function o(){n.countdown_sec=0,e&&clearInterval(e)}if(n.countdown_sec=0,n.toggleSearchBet=function(){$(".search_bet").slideToggle()},t.$on("afterGetData",function(t){r()}),t.$on("$destroy",function(t){o()}),"undefined"!=typeof Storage){var a=localStorage.getItem("countdown_time");if(a){var i=new Date;if((a=parseInt(a,10))>i.getTime())r(parseInt((a-i.getTime())/1e3,10))}}window.onbeforeunload=function(){if("undefined"!=typeof Storage&&n.countdown_sec){var t=new Date;t.setTime(t.getTime()+1e3*n.countdown_sec),localStorage.setItem("countdown_time",t.getTime())}}}])}();