!function(){function t(t){$(".waiting p").html(t),$(".waiting").fadeIn()}function e(t,e){function n(){this.isMatch=function(t,e){if("BB电子"!=t.platform)return!1;if(t.bet_amount<1)return!1;var n=e.split("|");return reg=new RegExp(n[0]+"$"),reg.test(t.bet_order_id)?!0:!1}}function r(){this.isMatch=function(t,e){if("BB电子"==t.platform)return!1;if(t.bet_amount<1)return!1;if(t.payout_amount<=0)return!1;var n=e.split("|");return t.payout_amount/t.bet_amount>n[0]?!0:!1}}var o=[],a={activity1:new n,activity2:new r};t.get(e+"/getActivities").then(function(t){o=t.data.data}),this.isMatch=function(t){for(var e=0,n=o.length;n>e;e++){var r=a["activity"+o[e].activity_id];if(r){var i=0;for(j_len=o[e].rules.length;i<j_len;i++)if(r.isMatch(t,o[e].rules[i]))return!0}}return!1}}var n=!1;$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},beforeSend:function(){n=!0},error:function(t){"419"==t.status?confirm("Session 已失效，请重新整理页面.")&&location.reload():alert("发生错误.")},complete:function(){n=!1}});var r=angular.module("jsApp",["ui.bootstrap"]);r.config(["$interpolateProvider","$compileProvider",function(t,e){t.startSymbol("{*"),t.endSymbol("*}"),e.commentDirectivesEnabled(!1),e.cssClassDirectivesEnabled(!1)}]),r.filter("offset",function(){return function(t,e){return e=parseInt(e,10),t.slice(e)}}),r.filter("platform",function(){return function(t,e){if(""==e)return t;for(var n=[],r=0,o=t.length;o>r;r++){var a=t[r];a.platform==e&&n.push(a)}return n}}),r.filter("tailNo",function(){return function(t,e){if(""==e)return t;for(var n=[],r=0,o=t.length,a=new RegExp(e+"$");o>r;r++){var i=t[r];a.test(i.bet_order_id)&&n.push(i)}return n}}),r.filter("amountGreaterThan",function(){return function(t,e){if(isNaN(e)||""==e)return t;for(var n=[],r=0,o=t.length;o>r;r++){var a=t[r];a.bet_amount>=e&&n.push(a)}return n}}),r.filter("matchedOnly",function(){return function(t,e){if(!e)return t;for(var n=[],r=0,o=t.length;o>r;r++){var a=t[r];a.matched&&n.push(a)}return n}}),r.service("activityService",e),e.$inject=["$http","BASE_URI"],r.controller("BodyCtrl",["$scope","$http","platformFilter","tailNoFilter","amountGreaterThanFilter","matchedOnlyFilter","activityService","username","BASE_URI",function(e,r,o,a,i,u,c,s,f){function l(){var t=u(m.bet_orders,m.qs.matched);t=a(t,m.qs.tail_no),t=o(t,m.qs.platform),t=i(t,m.qs.amount),m.filtered_bet_orders=t}function d(){for(var t=0,e=m.bet_orders.length;e>t;t++)m.bet_orders[t].matched=c.isMatch(m.bet_orders[t])?1:0}var m=this;m.username=s,m.bet_orders=[],m.filtered_bet_orders=[],m.msg=s?2:1,m.paginator={current:1,per_page:10},m.qs={platform:"",amount:"",tail_no:"",matched:!1},e.$watch(function(){return m.qs},function(){l()},!0),m.loginPopup=function(){$(".login_pop").fadeIn().find("input[name='username']").focus()},m.closeLoginPopup=function(){$(".login_pop").fadeOut()},m.login=function(){if(!n){var r=login_form;return""==r.username.value?void r.username.focus():""==r.balance.value?void r.balance.focus():isNaN(r.balance.value)?(alert("帳戶餘額格式不正確 !"),r.balance.focus(),r.balance.select(),void 0):void $.ajax({url:f+"/login",type:"post",dataType:"json",data:$(r).serialize(),beforeSend:function(){n=!0,t("登录中...")},success:function(t){-1==t.error||100==t.error?(alert("登录成功."),$(".login_pop").fadeOut(),m.username=t.msg,m.msg=2,r.username.value="",r.balance.value="",e.$digest()):t.msg?alert(t.msg):alert("发生未知的错误.")},complete:function(){n=!1,$(".waiting").fadeOut()}})}},m.logout=function(){confirm("是否登出 ?")&&r.get(f+"/logout").then(function(){m.username="",m.bet_orders=m.filtered_bet_orders=[],m.msg=1,alert("登出成功.")},function(t){alert("登出失败. ("+t.status+": "+t.statusText+")")})},m.getBetOrders=function(){return n?void 0:m.username?void $.ajax({url:f+"/getBetOrders",type:"post",dataType:"json",beforeSend:function(){n=!0,t("注单数据获取中，请耐心等待...")},success:function(t){-1==t.error?(m.bet_orders=t.data,m.msg=t.data.length?0:3,d(),l(),e.$broadcast("afterGetData"),e.$digest()):t.msg?alert(t.msg):alert("发生未知的错误.")},complete:function(){n=!1,$(".waiting").fadeOut()}}):void m.loginPopup()},m.applicable=function(t){return t.matched?!0:!1},m.activityApplying=function(e){n||$.ajax({url:f+"/activityApplying",type:"post",data:{bet_order_id:e.bet_order_id},dataType:"json",beforeSend:function(){n=!0,t("申请办理中，请耐心等待...")},success:function(t){-1==t.error?alert("申请成功."):t.msg?alert(t.msg):alert("发生未知的错误.")},complete:function(){n=!1,$(".waiting").fadeOut()}})}}]),r.controller("SearchFormCtrl",["$scope",function(t){function e(){--a.countdown_sec<=0&&r()}function n(n){a.countdown_sec=n?n:600,o=setInterval(function(){e(),t.$digest()},1e3)}function r(){a.countdown_sec=0,o&&clearInterval(o)}var o,a=this;if(a.countdown_sec=0,a.toggleSearchBet=function(){$(".search_bet").slideToggle()},t.$on("afterGetData",function(){n()}),t.$on("$destroy",function(){r()}),"undefined"!=typeof Storage){var i=localStorage.getItem("countdown_time");if(i){var u=new Date;if(i=parseInt(i,10),i>u.getTime()){var c=parseInt((i-u.getTime())/1e3,10);n(c)}}}window.onbeforeunload=function(){if("undefined"!=typeof Storage&&a.countdown_sec){var t=new Date;t.setTime(t.getTime()+1e3*a.countdown_sec),localStorage.setItem("countdown_time",t.getTime())}}}])}();
